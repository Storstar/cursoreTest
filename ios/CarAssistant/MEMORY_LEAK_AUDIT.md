# Аудит утечек памяти - Рекомендации

## Проверка с помощью Xcode Instruments

### 1. Memory Leak Detection
1. Откройте проект в Xcode
2. Выберите Product → Profile (Cmd+I)
3. Выберите "Leaks" инструмент
4. Запустите приложение и используйте все функции (чат, добавление авто, фото и т.д.)
5. Проверьте красные флаги утечек памяти

### 2. Allocations Profile
1. В Instruments выберите "Allocations"
2. Запустите приложение
3. Используйте функции приложения
4. Проверьте рост памяти (Memory Graph)
5. Используйте "Mark Generation" для отслеживания роста памяти

### 3. Memory Graph Debugger
1. В Xcode установите точку останова
2. Debug → Memory Graph
3. Проверьте циклические ссылки и утечки

## Потенциальные проблемы, которые нужно проверить

### 1. Изображения
- ✅ Добавлена очистка `selectedImage = nil` в `onDisappear` для ChatView и CarInputView
- ⚠️ Проверить: изображения в ChatBubble могут занимать много памяти
- ⚠️ Рекомендация: использовать thumbnail для больших изображений

### 2. Task и async функции
- ✅ Добавлена проверка отмены в цикле `while isWaitingForResponse` в ChatViewModel
- ⚠️ Проверить: все Task должны быть отменяемы при закрытии экранов
- ⚠️ Рекомендация: использовать `Task.checkCancellation()` в длительных операциях

### 3. ViewModels и @StateObject
- ⚠️ Проверить: ChatViewModel, RequestViewModel создаются как @StateObject - убедиться, что они освобождаются
- ⚠️ Рекомендация: использовать @ObservedObject вместо @StateObject где возможно

### 4. Core Data
- ⚠️ Проверить: контексты Core Data должны быть правильно настроены
- ⚠️ Рекомендация: использовать batch fetching для больших списков

### 5. NotificationCenter и Combine
- ⚠️ Проверить: все подписки должны быть отменены в `onDisappear`
- ⚠️ Рекомендация: использовать `AnyCancellable` и хранить в Set

### 6. Анимации и Timer
- ⚠️ Проверить: все Timer должны быть инвалидированы
- ⚠️ Рекомендация: использовать SwiftUI анимации вместо Timer где возможно

## Исправления, которые уже внесены

1. ✅ Очистка изображений в `onDisappear` для ChatView и CarInputView
2. ✅ Добавлена проверка отмены в цикле ожидания ответа в ChatViewModel
3. ✅ Очистка `selectedImage` при смене автомобиля

## Следующие шаги

1. Запустить Instruments и проверить утечки
2. Проверить рост памяти при длительном использовании
3. Оптимизировать загрузку изображений (thumbnail, кэширование)
4. Добавить отмену Task при закрытии экранов
5. Проверить все подписки на уведомления

